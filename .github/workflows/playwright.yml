name: E2E Tests

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [main]

jobs: 
    e2e:
        timeout-minutes: 60
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v4

        - name: Setup node.js 
          uses: actions/setup-node@v4
          with:
            node-version: 20

        - name: Install dependencies
          run: npm ci
        
        - name: Install Playwright
          run: npx playwright install --with-deps
        
        - name: Wait for Vercel preview deployment to be ready
          uses: patrickedqvist/wait-for-vercel-preview@v1.3.1
          id: waitForVercelPreview
          with: 
            token: ${{ secrets.GITHUB_TOKEN }}
            project: quiz-biblio-front

        - name: Run playwright tests on Vercel Preview
          env: 
            BASE_URL: ${{ steps.waitForVercelPreview.outputs.preview-url }}
            NODE_ENV: test
          run: |
            echo "Running tests on $BASE_URL"
            npx playwright test

        - uses: actions/upload-artifact@v4
          if: ${{ !cancelled() }}
          with:
            name: playwright-report
            path: playwright-report/
            retention-days: 30
